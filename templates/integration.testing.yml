steps:
  - task: NodeTool@0
    displayName: 'Use Node 14.x'
    inputs:
      versionSpec: 14.x
    
  - task: Cache@2
    displayName: 'Cache npm'
    inputs:
      key: 'npm | "$(Agent.OS)" | package-lock.json'
      restoreKeys: |
        npm | "$(Agent.OS)"
        npm
      path: $(npm_config_cache)

  - task: Npm@1
    displayName: npm custom
    inputs:
      command: custom
      verbose: false
      customCommand: install -g newman

  - script: |
      npm ci
    displayName: 'Install project dependencies'
    workingDirectory: $(Build.SourcesDirectory)  
      
  - script: newman run $(Build.SourcesDirectory)/tests/repair_poc.postman_collection.json -e $(Build.SourcesDirectory)/environments/Test.postman_environment.json && node index.js
    displayName: 'Run API Integration Tests'
  
  - task: PublishTestResults@2
    displayName: 'Publish Test Report'
    inputs:
      testResultsFormat: "JUnit"
      testResultsFiles: "**/api-test.*.xml"
      searchFolder: '$(Pipeline.Workspace)/s'
    condition: always()
    continueOnError: true